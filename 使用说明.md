# RF-DETRè®­ç»ƒä½¿ç”¨è¯´æ˜

## æ¦‚è¿°

æœ¬é¡¹ç›®æä¾›äº†ç®€åŒ–çš„RF-DETRè®­ç»ƒä»£ç ï¼Œä»¿ç…§YOLOè®­ç»ƒä»£ç ç»“æ„ï¼Œé’ˆå¯¹RTX5060 8Gæ˜¾å­˜å’ŒR9-8940 CPUä¼˜åŒ–é…ç½®ã€‚

## ç¡¬ä»¶é…ç½®ä¼˜åŒ–

### æ‚¨çš„ç¡¬ä»¶é…ç½®
- **CPU**: AMD R9-8940 (é«˜æ€§èƒ½å¤„ç†å™¨)  
- **GPU**: RTX5060 8Gæ˜¾å­˜ (ä¸­ç­‰æ˜¾å­˜å®¹é‡)
- **è®¾å¤‡**: å¤©é€‰6pro

### é’ˆå¯¹æ‚¨ç¡¬ä»¶çš„ä¼˜åŒ–é…ç½®
- **batch_size**: 4 (é€‚åˆ8Gæ˜¾å­˜)
- **grad_accum_steps**: 2 (ç­‰æ•ˆbatch_size=8) 
- **num_workers**: 8 (å……åˆ†åˆ©ç”¨R9-8940å¤šæ ¸æ€§èƒ½)
- **SGDä¼˜åŒ–å™¨**: lr=0.01, weight_decay=1e-4

## æ–‡ä»¶è¯´æ˜

### æ ¸å¿ƒæ–‡ä»¶

1. **`dataprocess.py`** - æ•°æ®æ ¼å¼è½¬æ¢è„šæœ¬
   - å°†YOLOæ ¼å¼æ•°æ®é›†è½¬æ¢ä¸ºRF-DETRéœ€è¦çš„COCOæ ¼å¼
   - è‡ªåŠ¨å¤„ç†å›¾åƒè·¯å¾„å’Œè¾¹ç•Œæ¡†åæ ‡è½¬æ¢

2. **`train.py`** - ç®€åŒ–è®­ç»ƒè„šæœ¬ (ä¸»è¦æ–‡ä»¶)
   - ä»¿ç…§YOLOè®­ç»ƒä»£ç ç»“æ„
   - 100è½®è®­ç»ƒï¼Œé’ˆå¯¹ç¡¬ä»¶ä¼˜åŒ–

3. **`pth_to_pt.py`** - æ¨¡å‹æ ¼å¼è½¬æ¢è„šæœ¬
   - å°†è®­ç»ƒå¥½çš„.pthæ ¼å¼è½¬æ¢ä¸º.ptæ ¼å¼
   - æ”¯æŒå•æ–‡ä»¶å’Œæ‰¹é‡è½¬æ¢

4. **`infer.py`** - æ¨¡å‹æ¨ç†æµ‹è¯•è„šæœ¬
   - éªŒè¯è®­ç»ƒå¥½çš„æ¨¡å‹æ£€æµ‹èƒ½åŠ›
   - æ”¯æŒå•å¼ å›¾åƒæ£€æµ‹å’Œç»“æœå¯è§†åŒ–

## é¡¹ç›®ç›®å½•ç»“æ„

è®­ç»ƒå®Œæˆåï¼Œé¡¹ç›®ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š
```
RF-DETR/
â”œâ”€â”€ datasets/           # åŸå§‹YOLOæ•°æ®é›†
â”‚   â””â”€â”€ Data/
â”œâ”€â”€ dataset/           # è½¬æ¢åçš„COCOæ ¼å¼æ•°æ®é›†
â”œâ”€â”€ runs/              # è®­ç»ƒç»“æœç›®å½•
â”‚   â””â”€â”€ train_rf-detr-small/
â”‚       â”œâ”€â”€ checkpoint_best_regular.pth    # æœ€ä½³å¸¸è§„æ¨¡å‹
â”‚       â”œâ”€â”€ checkpoint_best_ema.pth        # æœ€ä½³EMAæ¨¡å‹
â”‚       â”œâ”€â”€ checkpoint.pth                 # æœ€æ–°æ£€æŸ¥ç‚¹
â”‚       â”œâ”€â”€ metrics_plot.png              # è®­ç»ƒæŒ‡æ ‡å›¾
â”‚       â””â”€â”€ log.txt                       # è®­ç»ƒæ—¥å¿—
â”œâ”€â”€ train.py           # è®­ç»ƒè„šæœ¬ (å·²ä¼˜åŒ–ç²¾åº¦)
â”œâ”€â”€ infer.py           # æ¨ç†è„šæœ¬ (é€šç”¨åŒ–)
â”œâ”€â”€ dataprocess.py     # æ•°æ®è½¬æ¢è„šæœ¬ (è‡ªåŠ¨è¯»å–ç±»åˆ«)
â””â”€â”€ pth_to_pt.py       # æ¨¡å‹æ ¼å¼è½¬æ¢è„šæœ¬
```

> **ğŸ“ æ³¨æ„**: æ¨ç†è„šæœ¬(`infer.py`)å’Œè½¬æ¢å·¥å…·(`pth_to_pt.py`)ä¼šè‡ªåŠ¨æœç´¢è®­ç»ƒæ¨¡å‹ï¼š
> - ä¼˜å…ˆæŸ¥æ‰¾æ–°çš„`runs/train_rf-detr-small/`ç›®å½•
> - å‘åå…¼å®¹æ—§çš„`output/`ç›®å½•ç»“æ„

## âœ¨ æ–°åŠŸèƒ½ç‰¹æ€§

### ğŸ”§ é€šç”¨åŒ–æ”¹è¿›
- **è‡ªåŠ¨é€‚åº”ä»»ä½•æ•°æ®é›†**: ä¸å†å±€é™äºåƒåœ¾åˆ†ç±»
- **æ™ºèƒ½ç±»åˆ«è¯†åˆ«**: è‡ªåŠ¨ä»data.yamlè¯»å–ç±»åˆ«åç§°
- **åŠ¨æ€æ¨ç†**: æ¨ç†å·¥å…·è‡ªåŠ¨é€‚é…è®­ç»ƒçš„ç±»åˆ«æ•°é‡

### ğŸ“Š è®­ç»ƒä»£ç ä¼˜åŒ– (åŸºäºå®˜æ–¹ä»£ç )
- **RFDETRSmallæ¨¡å‹**: æ¯”å®˜æ–¹RFDETRBaseç²¾åº¦æ›´é«˜
- **å­¦ä¹ ç‡å¹³è¡¡**: 2e-4ï¼ŒåŸºäºå®˜æ–¹1e-4é€‚åº¦æå‡
- **ç¡¬ä»¶ä¼˜åŒ–**: æœ‰æ•ˆbatch_size=16ï¼Œé€‚é…8Gæ˜¾å­˜
- **ç®€æ´é«˜æ•ˆ**: éµå¾ªå®˜æ–¹ä»£ç é£æ ¼ï¼Œå»é™¤å†—ä½™å‚æ•°

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡
ç¡®ä¿å·²å®‰è£…ï¼š
```bash
pip install torch torchvision rfdetr pillow pyyaml
```

### 2. æ•°æ®é›†å‡†å¤‡
ç¡®ä¿YOLOæ•°æ®é›†ç»“æ„å¦‚ä¸‹ï¼š
```
datasets/
â””â”€â”€ Data/
    â”œâ”€â”€ train/
    â”‚   â”œâ”€â”€ images/     # JPGå›¾åƒæ–‡ä»¶
    â”‚   â””â”€â”€ labels/     # YOLOæ ¼å¼æ ‡æ³¨æ–‡ä»¶
    â”œâ”€â”€ val/
    â”‚   â”œâ”€â”€ images/
    â”‚   â””â”€â”€ labels/
    â””â”€â”€ test/           # å¯é€‰ï¼Œå¦‚æœæ²¡æœ‰ä¼šè‡ªåŠ¨å¤åˆ¶valæ•°æ®
        â”œâ”€â”€ images/
        â””â”€â”€ labels/
```

è½¬æ¢åå°†ç”ŸæˆCOCOæ ¼å¼ï¼š
```
dataset/
â”œâ”€â”€ train/
â”‚   â”œâ”€â”€ _annotations.coco.json
â”‚   â”œâ”€â”€ image1.jpg
â”‚   â””â”€â”€ image2.jpg
â”œâ”€â”€ valid/
â”‚   â”œâ”€â”€ _annotations.coco.json
â”‚   â”œâ”€â”€ image1.jpg
â”‚   â””â”€â”€ image2.jpg
â””â”€â”€ test/
    â”œâ”€â”€ _annotations.coco.json  # åŸå§‹testæˆ–å¤åˆ¶validé›†æ•°æ®
    â”œâ”€â”€ image1.jpg
    â””â”€â”€ image2.jpg
```

### 3. è®­ç»ƒæµç¨‹

```mermaid
graph TD
    A["datasets/Data/<br/>(YOLOæ ¼å¼)"] --> B["dataprocess.py<br/>æ•°æ®è½¬æ¢"]
    B --> C["dataset/<br/>(COCOæ ¼å¼)"]
    C --> D["train.py<br/>å¼€å§‹è®­ç»ƒ"]
    
    A1["datasets/Data/train/images/<br/>*.jpg"] --> A
    A2["datasets/Data/train/labels/<br/>*.txt"] --> A
    A3["datasets/Data/val/images/<br/>*.jpg"] --> A
    A4["datasets/Data/val/labels/<br/>*.txt"] --> A
    
    C1["dataset/train/<br/>*.jpg + _annotations.coco.json"] --> C
    C2["dataset/valid/<br/>*.jpg + _annotations.coco.json"] --> C
    C3["dataset/test/<br/>*.jpg + _annotations.coco.json"] --> C
    
    D --> E["runs/train_rf-detr-small/<br/>è®­ç»ƒç»“æœ"]
    
    style A fill:#e1f5fe
    style C fill:#f3e5f5
    style D fill:#e8f5e8
    style E fill:#fff3e0
```

### 4. å¼€å§‹è®­ç»ƒ
```bash
cd RF-DETR

# ç¬¬ä¸€æ­¥ï¼šè½¬æ¢æ•°æ®æ ¼å¼
python dataprocess.py

# ç¬¬äºŒæ­¥ï¼šå¼€å§‹è®­ç»ƒ
python train.py
```

### 5. æ¨¡å‹æ¨ç†æµ‹è¯• (è®­ç»ƒå®Œæˆå)
è®­ç»ƒå®Œæˆåï¼Œå¯ä»¥æµ‹è¯•æ¨¡å‹çš„æ£€æµ‹èƒ½åŠ›ï¼š

**å‡†å¤‡æµ‹è¯•å›¾åƒï¼š**
```bash
# å°†æ‚¨çš„æµ‹è¯•å›¾åƒé‡å‘½åä¸ºtest1.jpgå¹¶æ”¾åœ¨RF-DETRç›®å½•ä¸‹
# æˆ–è€…ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„ç¤ºä¾‹å›¾åƒ
```

**è¿è¡Œæ¨ç†æµ‹è¯•ï¼š**
```bash
python infer.py
# è‡ªåŠ¨åŠ è½½è®­ç»ƒå¥½çš„æ¨¡å‹ï¼Œå¯¹test1.jpgè¿›è¡Œæ£€æµ‹
# ç”Ÿæˆdetection_result.jpgæŸ¥çœ‹æ£€æµ‹ç»“æœ
```

### 6. æ¨¡å‹æ ¼å¼è½¬æ¢ (å¯é€‰)
è®­ç»ƒå®Œæˆåï¼Œå¯ä»¥å°†.pthæ ¼å¼è½¬æ¢ä¸º.ptæ ¼å¼ï¼š

**å¿«é€Ÿè½¬æ¢æ¨¡å¼ï¼š** â­æ¨è
```bash
python pth_to_pt.py
# è‡ªåŠ¨æ£€æµ‹è®­ç»ƒç›®å½•ä¸­çš„æ¨¡å‹æ–‡ä»¶ï¼Œé€‰æ‹©è½¬æ¢
```

**å‘½ä»¤è¡Œè½¬æ¢ï¼š**
```bash
# è½¬æ¢æœ€ä½³æ¨¡å‹
python pth_to_pt.py runs/train_rf-detr-small/checkpoint_best_regular.pth -o final_model.pt

# è½¬æ¢EMAæ¨¡å‹  
python pth_to_pt.py runs/train_rf-detr-small/checkpoint_best_ema.pth -o final_model_ema.pt

# æ‰¹é‡è½¬æ¢è®­ç»ƒç›®å½•
python pth_to_pt.py runs/train_rf-detr-small/ --batch
```

## è®­ç»ƒå‚æ•°è¯´æ˜

### ä¸»è¦å‚æ•°ï¼ˆåœ¨train.pyä¸­å¯è°ƒæ•´ï¼‰

**ğŸ“ˆ åŸºäºå®˜æ–¹ä»£ç ä¼˜åŒ–ç‰ˆæœ¬å‚æ•°ï¼š**
- **æ¨¡å‹**: RFDETRSmall (æ¯”å®˜æ–¹RFDETRBaseç²¾åº¦æ›´é«˜) ğŸ†•
- **epochs**: 100è½®è®­ç»ƒ
- **batch_size**: 4 (é€‚åˆ8Gæ˜¾å­˜)
- **grad_accum_steps**: 4 (ç­‰æ•ˆbatch_size=16)
- **lr**: 2e-4 (åŸºäºå®˜æ–¹1e-4é€‚åº¦æå‡)
- **output_dir**: 'runs/train_rf-detr-small'

**ğŸ’¡ ä¼˜åŒ–è¦ç‚¹ï¼š**
- åŸºäºRF-DETRå®˜æ–¹ä»£ç é£æ ¼
- ä½¿ç”¨æ›´é«˜ç²¾åº¦çš„Smallæ¨¡å‹
- å¹³è¡¡çš„å­¦ä¹ ç‡è®¾ç½®(2e-4)
- ç®€æ´é«˜æ•ˆçš„å‚æ•°é…ç½®

## è®­ç»ƒç›‘æ§

è®­ç»ƒè¿‡ç¨‹ä¼šæ˜¾ç¤ºï¼š
- å½“å‰epochè¿›åº¦
- è®­ç»ƒæŸå¤±
- éªŒè¯mAP
- å­¦ä¹ ç‡
- æ¯è½®è€—æ—¶

æ¨¡å‹è‡ªåŠ¨ä¿å­˜åœ¨`runs/train_rf-detr-small`ç›®å½•ã€‚

## æ€§èƒ½é¢„æœŸ

### åŸºäºæ‚¨çš„ç¡¬ä»¶ (RTX5060 8G + R9-8940)
- **æ¯è½®è®­ç»ƒ**: çº¦2-3åˆ†é’Ÿ
- **100è½®æ€»æ—¶é—´**: çº¦3-5å°æ—¶
- **æ˜¾å­˜å ç”¨**: çº¦6-7GB

## å¸¸è§é—®é¢˜

### Q: æ˜¾å­˜ä¸è¶³æ€ä¹ˆåŠï¼Ÿ
ä¿®æ”¹train.pyä¸­çš„batch_sizeï¼š
```python
batch_size=2,               # ä»4æ”¹ä¸º2
grad_accum_steps=4,         # ä»2æ”¹ä¸º4
```

### Q: æ•°æ®æ ¼å¼è½¬æ¢å¤±è´¥ï¼Ÿ
æ£€æŸ¥ï¼š
- ç¡®ä¿datasets/Data/trainå’Œdatasets/Data/valç›®å½•å­˜åœ¨
- ç¡®ä¿imageså’Œlabelså­ç›®å½•éƒ½æœ‰æ–‡ä»¶
- æ ‡æ³¨æ ¼å¼ï¼šç±»åˆ«ID x_center y_center width height

### Q: æƒ³è°ƒæ•´è®­ç»ƒå‚æ•°ï¼Ÿ
ç›´æ¥ä¿®æ”¹train.pyæ–‡ä»¶ä¸­çš„å‚æ•°å³å¯ã€‚

### Q: å¦‚ä½•æµ‹è¯•è®­ç»ƒå¥½çš„æ¨¡å‹ï¼Ÿ
ä½¿ç”¨infer.pyè„šæœ¬ï¼š
```bash
# å‡†å¤‡æµ‹è¯•å›¾åƒtest1.jpgï¼Œç„¶åè¿è¡Œ
python infer.py
# æŸ¥çœ‹detection_result.jpgè·å¾—æ£€æµ‹ç»“æœ
```

### Q: å¦‚ä½•è½¬æ¢æ¨¡å‹æ ¼å¼ï¼Ÿ
ä½¿ç”¨pth_to_pt.pyè„šæœ¬ï¼š
```bash
# å¿«é€Ÿè½¬æ¢æ¨¡å¼ï¼ˆæ¨èï¼‰
python pth_to_pt.py
# è‡ªåŠ¨æ‰«æè®­ç»ƒç›®å½•ï¼Œé€‰æ‹©è¦è½¬æ¢çš„æ¨¡å‹

# æ‰‹åŠ¨è½¬æ¢æœ€ä½³æ¨¡å‹
python pth_to_pt.py runs/train_rf-detr-small/checkpoint_best_regular.pth -o my_model.pt

# è½¬æ¢EMAæ¨¡å‹
python pth_to_pt.py runs/train_rf-detr-small/checkpoint_best_ema.pth -o my_model_ema.pt
```

## ä¸YOLOå¯¹æ¯”

| å‚æ•° | YOLO | RF-DETR |
|------|------|---------|
| epochs | 150 | 100 |
| batch | 12 | 4 |
| workers | 16 | 8 |

ç¥è®­ç»ƒé¡ºåˆ©ï¼ğŸš€